{
    "contents" : "#Functions -- Annual Spending Function\n \nlibrary(Rcpp) \nlibrary(ggplot2)\nlibrary(reshape2)\n\n# function tpv returns the integer year in which the spending model\n# portfolio balance falls to zero. x is the vector containing market return growth\n# factors (market return plus one). initportfolio is the initial portfolio balance.\n# years is the max number of years to calculate (function returns 99 if balance never\n# falls to zero.) spending contains the constant annual spending amount. \n# Start C++ vector index at zero (R starts at 1.)\n\ncppFunction('int tpv (NumericVector x, int initportfolio, int years, double spending) {\n  int balance = initportfolio;\n  int k;\n  \n  for (k = 0; k <= years-1; ++k) {\n    balance = (balance - spending); \n    if (balance >= 0) balance = balance * x[k];\n  }\n  return balance;\n}'\n)\n\nprint (\" \")\nprint (\" \")\nprint(\"**********************\")\nprint(\"Print TPV's with Random Lifetimes\")\nprint(\"**********************\")\n\n# Working directories (set to \"\" to use current working directory)\nmodelWD <- \"/Users/dirkcotton/CourseraR/Retirement 2/\"\nfigureWD <- \"~/Desktop/R/Return Uncertainty Post/\" # directory to store all plots generated\n\n# Initialize variables \n\nset.seed(27514)\nscenarios <- 10000\nyears <- max(lifeSpanJoint$V1)\ngeoMeanC <- rep(0,scenarios)\nresultC <- rep(0,scenarios)\nstdev <- rep(0,scenarios)\nspending <- 40000\nport <- 1000000\nmu <- .05\nsigma <- 0.11\n\n# Build random lifetimes\n\nptm <- proc.time()\n\nfor (i in 1:scenarios) {\n  x <- rlnorm(years,mu,sigma)\n  geoMeanC[i] <- exp(mean(log(x))) - 1\n  resultC[i] <- tpv(x,port,lifeSpanJoint$V1[i],spending)\n  stdev[i] <- sd(x)\n} \nproc.time() - ptm \n\nscatplot.df <- data.frame(cbind(geoMeanC,resultC))\ncolnames(scatplot.df) <- c(\"Return\",\"TPV\")\nscatplot.df[[\"sign\"]] = ifelse(scatplot.df[[\"TPV\"]] < 0, \"Ruin\",ifelse(scatplot.df[[\"TPV\"]] < port, \"CondSuccess\",\"Success\"))\nscatplot.df <- melt(scatplot.df,id.vars = c(\"Return\",\"TPV\"))\nscatplot.df[,3] <- NULL\ncolnames(scatplot.df) <- c(\"Return\",\"values\",\"Sign\")\n\noptions (scipen = 8) # change x-axis from scientific notation to integer\n\np <- ggplot(scatplot.df, aes(Return*100,values/1000000,fill=Sign)) +\n  scale_color_manual(values = c(\"Success\" = \"blue3\",\"CondSuccess\"=\"blue1\", \"Ruin\" = \"red\")) +\n  geom_point(aes(color = Sign),size=1) +\n  xlab(\"Percent Geometric Mean Annual Return\") + ylab(\"Terminal Portfolio Value ($M)\") +\n  scale_linetype_discrete(name = \"\") +\n  theme_gray() +\n  xlim(c(0,10)) +\n  ylim(c(-1,7.6)) +\n  theme_set(theme_gray(base_size = 12)) +\n  theme(text=element_text(family=\"Times\")) +\n  theme(legend.title=element_blank()) + \n  theme(legend.position='none') +\n  geom_vline(xintercept=mu*100) + geom_hline(yintercept=0) +\n  ggtitle(paste(\"Terminal Portfolio Values Assuming\\nJoint Life Expectancy, \",spending/port*100,\"% Withdrawals\",sep=\"\") )\n print(p)\n \nmtpvr <- mean(resultC)\nprint(paste(\"Mean TPV is: \",round(mtpvr,0)),sep=\"\")\nprint(paste(\"Mean TPV is\",round(((mtpvr-mtpvf)/mtpvf)*100,1),\" % lower than for fixed lifetimes.\"),sep=\"\")\n\nrruin <- sum(resultC<=0)/scenarios\n\nprint(paste(\"Probability of Ruin is:\",rruin*100,\"%\"),sep=\"\")\n\nprint(paste(\"Prob Ruin for Random lifetimes is\",round(((rruin-fruin)/fruin)*100,1),\" % lower than for fixed lifetimes.\"),sep=\"\")\n\nq2 <- subset(scatplot.df,Return<.05 & Return >=.025 & values <=0)\nq3 <- subset(scatplot.df,Return<.075 & Return >=.05 & values <=0)\nq4 <- subset(scatplot.df,Return >=.075 & values <=0)\nq1 <- subset(scatplot.df,Return<.025 & values <=0)\n\nruinQ1 <- length(q1$Return) # count ruined portfolios\nruinQ2 <- length(q2$Return)\nruinQ3 <- length(q3$Return)\nruinQ4 <- length(q4$Return)\n\nsizeQ1 <- sum(scatplot.df$Return < .025) # count number of outcomes in this range of returns\nsizeQ2 <- sum(scatplot.df$Return >=.025 & scatplot.df$Return < .05)\nsizeQ3 <- sum(scatplot.df$Return >=.05 & scatplot.df$Return < .075)\nsizeQ4 <- sum(scatplot.df$Return >=.075)\n\nmtpvQ1 =  mean(scatplot.df$values[scatplot.df$Return<.025])\nmtpvQ4 =  mean(scatplot.df$values[scatplot.df$Return>=.075])\nmtpvQ3 =  mean(scatplot.df$values[scatplot.df$Return>=.05 & scatplot.df$Return<.075])\nmtpvQ2 =  mean(scatplot.df$values[scatplot.df$Return>=.025 & scatplot.df$Return<.05])\n\nprint(paste(\"Distribution of Geometric Mean Returns**************\"),sep=\"\")\nprint(paste(\"Prob return < .025 is:\",sizeQ1/scenarios*100,\"%\",\"Prob of Ruin is: \",round(ruinQ1/sizeQ1*100,1),\"%\"),sep=\"\")\nprint(paste(\"Prob return .025 to .05 is:\",sizeQ2/scenarios*100,\"%\",\"Prob of Ruin is: \",round(ruinQ2/sizeQ2*100,1),\"%\"),sep=\"\")\nprint(paste(\"Prob return .05 to .075 is:\",sizeQ3/scenarios*100,\"%\",\"Prob of Ruin is: \",round(ruinQ3/sizeQ3*100,1),\"%\"),sep=\"\")\nprint(paste(\"Prob return >.075 is:\",sizeQ4/scenarios*100,\"%\",\"Prob of Ruin is: \",round(ruinQ4/sizeQ4*100,1),\"%\"),sep=\"\")\n\nprint(paste(\"Q1 mean TPV is: \",round(mtpvQ1,0),sep=\"\"))\nprint(paste(\"Q2 mean TPV is: \",round(mtpvQ2,0),sep=\"\"))\nprint(paste(\"Q3 mean TPV is: \",round(mtpvQ3,0),sep=\"\"))\nprint(paste(\"Q4 mean TPV is: \",round(mtpvQ4,0),sep=\"\"))\n\n# Plot age against TPV\n\natpv.df <- data.frame(cbind(lifeSpanJoint$V1+65,resultC))\ncolnames(atpv.df) <- c(\"Age\",\"TPV\")\n\np2 <- ggplot(atpv.df, aes(Age,TPV/1000000)) +\n  # scale_color_manual(values = c(\"Success\" = \"blue3\",\"CondSuccess\"=\"blue1\", \"Ruin\" = \"red\")) +\n  geom_point(size=1) +\n  xlab(\"Age\") + ylab(\"Terminal Portfolio Value ($M)\") +\n  scale_linetype_discrete(name = \"\") +\n  xlim(c(65,100)) +\n  ylim(c(-1,10)) +\n  theme_set(theme_gray(base_size = 12)) +\n  theme(text=element_text(family=\"Times\")) +\n  theme_gray() + theme(legend.position='none') +\n  #geom_vline(xintercept=mu*100) + geom_hline(yintercept=0) +\n  ggtitle(\"Terminal Portfolio Values versus Age at Death\")\nprint(p2)\n",
    "created" : 1448806362889.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3498008089",
    "id" : "3FC0AA5C",
    "lastKnownWriteTime" : 1448807295,
    "path" : "~/Desktop/R/Return Uncertainty Post/Plot TPV vs Return Random Lifetimes.R",
    "project_path" : "Plot TPV vs Return Random Lifetimes.R",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "type" : "r_source"
}